<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MQTT Motion Chair Device</title>
    <script src="https://unpkg.com/paho-mqtt@1.1.0/paho-mqtt-min.js"></script>
    <script>
        // Lazy load Socket.IO for bridge mode
        function loadSocketIo(src = "https://cdn.socket.io/4.4.1/socket.io.min.js") {
            return new Promise((resolve, reject) => {
                if (window.io) {
                    return resolve();
                }
                const s = document.createElement("script");
                s.src = src;
                s.onload = () => resolve();
                s.onerror = reject;
                document.head.appendChild(s);
            });
        }

        // Group/Individual session helpers
        function joinSession() {
            const sid = (document.getElementById("sessionInput").value || "").trim();
            if (!sid) {
                alert("Enter Session ID");
                return;
            }
            state.sessionId = sid;
            setK("s_session", sid);
            try {
                localStorage.setItem("nsc_device_session", sid);
            } catch { }
            // Subscribe to group command topic
            sub(`sessions/${sid}/commands/+`);
            // Notify status with session
            const statusPayload = {
                deviceId: state.id,
                type: state.type,
                status: state.playing ? "active" : "idle",
                positionMs: Math.floor(state.positionMs),
                sessionId: sid,
                timestamp: new Date().toISOString(),
            };
            try {
                if (bridge && connected) bridge.emit("device:status", statusPayload);
            } catch { }
            pub(T_status(state.id), JSON.stringify(statusPayload), true);
            // Fetch current ongoing session details and populate journey telemetry
            try {
                fetchOngoingSessionDetails();
            } catch { }
        }

        function leaveSession() {
            const sid = state.sessionId;
            state.sessionId = "";
            setK("s_session", "-");
            try {
                localStorage.removeItem("nsc_device_session");
            } catch { }
            // No global unsubscribe to avoid removing backend subs; device will ignore further messages by not matching sessionId
            const statusPayload = {
                deviceId: state.id,
                type: state.type,
                status: state.playing ? "active" : "idle",
                positionMs: Math.floor(state.positionMs),
                sessionId: "",
                timestamp: new Date().toISOString(),
            };
            try {
                if (bridge && connected) bridge.emit("device:status", statusPayload);
            } catch { }
            pub(T_status(state.id), JSON.stringify(statusPayload), true);
        }

        // Device -> Admin events (user-triggered commands)
        function sendEvent(evt, extra) {
            const payload = {
                deviceId: state.id,
                type: state.type,
                event: evt,
                positionMs: Math.floor(state.positionMs),
                sessionId: state.sessionId || "",
                journeyId: state.journeyId || "",
                timestamp: new Date().toISOString(),
                ...(extra || {}),
            };
            // Via bridge
            try {
                if (bridge && connected)
                    bridge.emit("mqtt_publish", {
                        topic: `devices/${state.id}/events`,
                        payload: JSON.stringify(payload),
                        options: { qos: 1, retain: false },
                    });
            } catch { }
            // Also publish over MQTT topic for parity
            console.log("publishing", payload);
            pub(`devices/${state.id}/events`, JSON.stringify(payload), false);
        }
    </script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            height: 100vh;
            overflow: hidden;
            padding: 12px;
        }

        .container {
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 12px 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .header h1 {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: inline;
        }

        .header .subtitle {
            color: #6b7280;
            font-size: 12px;
            margin: 0;
            display: inline;
            margin-left: 12px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr 300px;
            gap: 12px;
            flex: 1;
            min-height: 0;
        }

        .left-panel,
        .center-panel,
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 0;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            margin: 0 0 12px 0;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }

        .card-title::before {
            content: "";
            width: 3px;
            height: 16px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 2px;
        }

        .form-group {
            margin-bottom: 10px;
        }

        label {
            font-size: 11px;
            font-weight: 500;
            color: #374151;
            display: block;
            margin-bottom: 4px;
        }

        input,
        select {
            width: 100%;
            padding: 6px 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 13px;
            transition: all 0.2s;
            background: white;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #f093fb;
            box-shadow: 0 0 0 3px rgba(240, 147, 251, 0.1);
        }

        .button-group {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        button {
            padding: 6px 12px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 2px solid #e5e7eb;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #f3f4f6;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            color: #374151;
        }

        .status-badge.connected {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.connected::before {
            content: "";
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-badge.disconnected::before {
            content: "";
            width: 8px;
            height: 8px;
            background: #6b7280;
            border-radius: 50%;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            flex: 1;
            overflow-y: auto;
        }

        .info-item {
            background: #f9fafb;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .info-label {
            font-size: 9px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .info-value {
            font-size: 12px;
            font-weight: 600;
            color: #1f2937;
            word-break: break-all;
        }

        .log {
            flex: 1;
            overflow: auto;
            background: #1f2937;
            color: #e5e7eb;
            font-family: "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Consolas, "Courier New", monospace;
            font-size: 10px;
            padding: 10px;
            border-radius: 8px;
            line-height: 1.4;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .log::-webkit-scrollbar {
            width: 8px;
        }

        .log::-webkit-scrollbar-track {
            background: #374151;
            border-radius: 4px;
        }

        .log::-webkit-scrollbar-thumb {
            background: #6b7280;
            border-radius: 4px;
        }

        .telemetry-viewer {
            flex: 1;
            overflow-y: auto;
            background: #f9fafb;
            border-radius: 8px;
            padding: 10px;
            font-family: "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Consolas, "Courier New", monospace;
            font-size: 11px;
            line-height: 1.6;
        }

        .telemetry-viewer pre {
            margin: 0;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }

        .empty-state svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .divider {
            height: 1px;
            background: #e5e7eb;
            margin: 10px 0;
        }

        .motion-indicator {
            background: #1f2937;
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
        }

        .motion-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            color: #e5e7eb;
            font-size: 11px;
        }

        .motion-row:last-child {
            margin-bottom: 0;
        }

        .motion-label {
            color: #9ca3af;
            font-weight: 500;
        }

        .motion-value {
            color: #10b981;
            font-weight: 600;
            font-family: "SF Mono", Monaco, monospace;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üí∫ Motion Chair Simulator</h1>
            <span class="subtitle">Motion Chair Testing Interface - Telemetry Sync</span>
        </div>

        <!-- Main 3-Column Grid -->
        <div class="main-grid">
            <!-- LEFT PANEL -->
            <div class="left-panel">
                <!-- Connection -->
                <div class="card" style="flex-shrink: 0">
                    <h2 class="card-title">Connection</h2>
                    <div class="form-group">
                        <label>Backend URL</label>
                        <input id="mqttUrl" value="http://localhost:8001" />
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px">
                        <div class="form-group" style="margin: 0">
                            <label>Type</label>
                            <select id="deviceType">
                                <option value="chair">üí∫ Chair</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin: 0">
                            <label>Device ID</label>
                            <input id="deviceId" placeholder="CHAIR_#001" />
                        </div>
                    </div>
                    <div class="button-group">
                        <button id="btnConnect" class="btn-success" onclick="connectBroker()">‚ö° Connect</button>
                        <button id="btnDisconnect" class="btn-danger" onclick="disconnectBroker()" disabled>‚èπ
                            Disconnect</button>
                    </div>
                    <div style="margin-top: 8px">
                        <div id="connStatus" class="status-badge disconnected">Disconnected</div>
                    </div>
                </div>

                <!-- Device Info -->
                <div class="card" style="flex: 1; min-height: 0">
                    <h2 class="card-title">Device Info</h2>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Type</div>
                            <div class="info-value" id="s_type">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Device ID</div>
                            <div class="info-value" id="s_id">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Session</div>
                            <div class="info-value" id="s_session">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Peer VR</div>
                            <div class="info-value" id="s_peer">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Journey</div>
                            <div class="info-value" id="s_journey">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">State</div>
                            <div class="info-value" id="s_state">idle</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Position</div>
                            <div class="info-value" id="s_pos">0:00</div>
                        </div>
                    </div>
                </div>

                <!-- Session Management -->
                <div class="card" style="flex-shrink: 0">
                    <h2 class="card-title">Session</h2>
                    <div class="form-group">
                        <label>Session ID</label>
                        <input id="sessionInput" placeholder="S_XXXX" />
                    </div>
                    <div class="button-group" style="margin-bottom: 8px">
                        <button class="btn-success" onclick="joinSession()">‚úì Join</button>
                        <button class="btn-danger" onclick="leaveSession()">‚úó Leave</button>
                    </div>
                    <div class="divider"></div>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="sendEvent('play')">‚ñ∂</button>
                        <button class="btn-secondary" onclick="sendEvent('pause')">‚è∏</button>
                        <button class="btn-secondary" onclick="sendEvent('stop')">‚èπ</button>
                        <button class="btn-secondary" onclick="sendEvent('reset')">‚Üª</button>
                    </div>
                </div>
            </div>

            <!-- CENTER PANEL -->
            <div class="center-panel">
                <!-- Motion Status -->
                <div class="card" style="flex: 1; min-height: 0">
                    <h2 class="card-title">Motion Status</h2>
                    <div class="motion-indicator">
                        <div class="motion-row">
                            <span class="motion-label">Pitch:</span>
                            <span class="motion-value" id="motion_pitch">0.0¬∞</span>
                        </div>
                        <div class="motion-row">
                            <span class="motion-label">Roll:</span>
                            <span class="motion-value" id="motion_roll">0.0¬∞</span>
                        </div>
                        <div class="motion-row">
                            <span class="motion-label">Yaw:</span>
                            <span class="motion-value" id="motion_yaw">0.0¬∞</span>
                        </div>
                        <div class="motion-row">
                            <span class="motion-label">Heave:</span>
                            <span class="motion-value" id="motion_heave">0.0mm</span>
                        </div>
                        <div class="motion-row">
                            <span class="motion-label">Surge:</span>
                            <span class="motion-value" id="motion_surge">0.0mm</span>
                        </div>
                        <div class="motion-row">
                            <span class="motion-label">Sway:</span>
                            <span class="motion-value" id="motion_sway">0.0mm</span>
                        </div>
                    </div>
                    <div
                        style="margin-top: 12px; padding: 8px; background: #f9fafb; border-radius: 8px; font-size: 11px; color: #6b7280;">
                        <strong>Current Telemetry Frame:</strong> <span id="current_frame">-</span>
                    </div>
                </div>

                <!-- Logs -->
                <div class="card" style="flex: 1; min-height: 0">
                    <h2 class="card-title">System Logs</h2>
                    <div id="log" class="log"></div>
                </div>
            </div>

            <!-- RIGHT PANEL -->
            <div class="right-panel">
                <!-- Telemetry Data -->
                <div class="card" style="flex: 1; min-height: 0">
                    <h2 class="card-title">Telemetry JSON</h2>
                    <div id="telemetryViewer" class="empty-state"
                        style="flex: 1; display: flex; align-items: center; justify-content: center; flex-direction: column">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            style="width: 32px; height: 32px; margin-bottom: 8px; opacity: 0.5">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <div style="font-size: 11px">No telemetry loaded</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let client = null; // Paho client (unused in forced bridge mode)
        let bridge = null; // Socket.IO client (bridge mode)
        let connected = false;
        let ticker = null;
        let mode = "bridge";
        const state = {
            id: "",
            type: "chair",
            name: "",
            sessionId: "",
            peer: "",
            journeyId: "",
            sessionType: "",
            playing: false,
            positionMs: 0,
            lastTick: 0,
            telemetryData: null,
            currentFrame: null,
        };
        let backendBaseUrl = "";

        // Utils
        function rand(n = 6) {
            return Math.random()
                .toString(36)
                .slice(2, 2 + n)
                .toUpperCase();
        }
        function appendRand(el) {
            if (!el._touched) {
                el.value += rand();
                el._touched = true;
            }
        }
        function log(msg) {
            const el = document.getElementById("log");
            const ts = new Date().toLocaleTimeString();
            el.textContent += `[${ts}] ${msg}\n`;
            el.scrollTop = el.scrollHeight;
            console.log(msg);
        }
        function setK(id, v) {
            const el = document.getElementById(id);
            if (el) el.textContent = v;
        }
        function setConnStatus(t, isConnected) {
            const el = document.getElementById("connStatus");
            if (!el) return;
            el.textContent = t;
            el.className = isConnected ? "status-badge connected" : "status-badge disconnected";
        }

        // MQTT topics helpers (backend-aligned)
        function T_discovery_announce() {
            return "devices/discovery/announce";
        }
        function T_status(id) {
            return `devices/${id}/status`;
        }
        function T_heartbeat(id) {
            return `devices/${id}/heartbeat`;
        }
        function T_cmd_any(id) {
            return `devices/${id}/commands/+`;
        }

        function connectBroker() {
            if (connected) return;
            const url = document.getElementById("mqttUrl").value.trim();
            backendBaseUrl = url;
            // Read device type from selector; name optional/internal
            state.type = document.getElementById("deviceType").value || "chair";
            state.id = document.getElementById("deviceId").value.trim() || "CHAIR_" + rand(8);
            state.name = "";
            setK("s_type", "üí∫ Chair");
            setK("s_id", state.id);

            // Restore sessionId from storage if present
            try {
                const savedSid = localStorage.getItem("nsc_device_session");
                if (savedSid) {
                    state.sessionId = savedSid;
                    document.getElementById("sessionInput").value = savedSid;
                    setK("s_session", savedSid);
                }
            } catch { }

            // Force Socket.IO bridge mode for simplicity
            mode = "bridge";
            loadSocketIo()
                .then(() => {
                    bridge = io(url, { transports: ["websocket"] });
                    bridge.on("connect", () => {
                        connected = true;
                        setConnStatus("Connected", true);
                        log("Bridge connected to " + url);
                        toggleButtons();
                        // Identify to backend for immediate offline on disconnect
                        bridge.emit("device:identify", { deviceId: state.id, type: state.type, name: state.name });
                        // Subscribe to device command topics
                        sub(T_cmd_any(state.id));
                        // If we have a session, re-subscribe; also try to discover ongoing session and telemetry
                        if (state.sessionId) {
                            sub(`sessions/${state.sessionId}/commands/+`);
                        }
                        try {
                            fetchOngoingSessionDetails();
                        } catch { }
                        // announce + status
                        pub(
                            T_discovery_announce(),
                            JSON.stringify({
                                deviceId: state.id,
                                type: state.type,
                                name: state.name,
                                metadata: {},
                                timestamp: new Date().toISOString(),
                            }),
                            false,
                        );
                        const statusPayload = {
                            deviceId: state.id,
                            type: state.type,
                            status: "active",
                            positionMs: Math.floor(state.positionMs),
                            sessionId: state.sessionId || "",
                            timestamp: new Date().toISOString(),
                        };
                        // MQTT status
                        pub(T_status(state.id), JSON.stringify(statusPayload), true);
                        // Socket.IO status fallback
                        try {
                            bridge.emit("device:status", statusPayload);
                        } catch { }
                        // Immediate heartbeat over Socket.IO and MQTT
                        try {
                            bridge.emit("device:heartbeat", {
                                deviceId: state.id,
                                type: state.type,
                                status: "active",
                                timestamp: new Date().toISOString(),
                            });
                        } catch { }
                        pub(
                            T_heartbeat(state.id),
                            JSON.stringify({ timestamp: new Date().toISOString(), status: "active" }),
                            false,
                        );
                        startTicker();
                    });
                    bridge.on("disconnect", () => {
                        connected = false;
                        setConnStatus("Disconnected", false);
                        toggleButtons();
                        stopTicker();
                    });
                    bridge.on("mqtt_message", ({ topic, payload }) => {
                        const msg = {
                            destinationName: topic,
                            payloadString: typeof payload === "string" ? payload : JSON.stringify(payload || {}),
                        };
                        onMsg(msg);
                    });
                })
                .catch((err) => {
                    log("Socket.IO load/connect failed: " + (err?.message || err));
                });
        }

        function disconnectBroker() {
            if (mode === "bridge" && bridge) {
                bridge.disconnect();
                bridge = null;
            }
            if (mode === "mqtt" && client) {
                client.disconnect();
                client = null;
            }
        }
        function toggleButtons() {
            document.getElementById("btnConnect").disabled = connected;
            document.getElementById("btnDisconnect").disabled = !connected;
        }

        function sub(topic) {
            if (!connected) return;
            if (mode === "bridge") {
                bridge.emit("mqtt_subscribe", { topic, options: { qos: 1 } });
                log("Sub (bridge) " + topic);
            } else {
                client.subscribe(topic, { qos: 1 });
                log("Sub " + topic);
            }
        }
        function pub(topic, payload, retain = false) {
            if (!connected) return;
            if (mode === "bridge") {
                bridge.emit("mqtt_publish", { topic, payload, options: { qos: 1, retain } });
                log(`Pub (bridge) ${topic} ${payload}`);
            } else {
                const PahoMessage = Paho.Message || (Paho.MQTT && Paho.MQTT.Message);
                const m = new PahoMessage(payload);
                m.destinationName = topic;
                m.qos = 1;
                m.retained = retain;
                client.send(m);
                log(`Pub ${topic} ${payload}`);
            }
        }

        function onMsg(msg) {
            const t = msg.destinationName;
            const p = msg.payloadString || "";
            log("Msg " + t + " " + p);
            try {
                const cmdPrefix = `devices/${state.id}/commands/`;
                if (t.startsWith(cmdPrefix)) {
                    const data = JSON.parse(p || "{}");
                    data.command = t.substring(cmdPrefix.length);
                    handleCmd(data);
                } else if (state.sessionId) {
                    const sessPrefix = `sessions/${state.sessionId}/commands/`;
                    if (t.startsWith(sessPrefix)) {
                        const data = JSON.parse(p || "{}");
                        data.command = t.substring(sessPrefix.length);
                        handleCmd(data);
                    }
                }
            } catch (e) {
                log("Parse error: " + e.message);
            }
        }

        async function fetchOngoingSessionDetails() {
            if (!backendBaseUrl) return;
            try {
                const url = `${backendBaseUrl}/api/sessions?status=on_going`;
                const res = await fetch(url);
                const json = await res.json();
                const list = Array.isArray(json?.data?.data) ? json.data.data : Array.isArray(json?.data) ? json.data : [];
                const first = Array.isArray(list) && list.length ? list[0] : null;
                if (!first) {
                    document.getElementById("telemetryViewer").innerHTML = `
            <div style="flex: 1; display: flex; align-items: center; justify-content: center; flex-direction: column; color: #9ca3af;">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 32px; height: 32px; margin-bottom: 8px; opacity: 0.5;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              <div style="font-size: 11px;">No ongoing session.</div>
            </div>
          `;
                    return;
                }
                const sid = String(first.id || "").trim();
                const stype = String(first.session_type || first?.data?.session_type || "").toLowerCase();
                state.sessionType = stype;
                if (sid && !state.sessionId) {
                    state.sessionId = sid;
                    setK("s_session", sid);
                    try {
                        localStorage.setItem("nsc_device_session", sid);
                    } catch { }
                    sub(`sessions/${sid}/commands/+`);
                }

                // For chair device, fetch only telemetry data from journeys
                const journeys = Array.isArray(first.journeys)
                    ? first.journeys
                    : Array.isArray(first.data?.journeys)
                        ? first.data.journeys
                        : [];

                if (journeys.length > 0) {
                    // Auto-select first journey for telemetry
                    const firstJourney = journeys[0];
                    const jid = String(firstJourney?.journey?.id || "");
                    if (jid) {
                        await loadJourneyTelemetry(jid);
                    }
                }
            } catch (e) {
                log("fetchOngoingSessionDetails error: " + (e?.message || e));
                document.getElementById("telemetryViewer").innerHTML = `
          <div style="flex: 1; display: flex; align-items: center; justify-content: center; flex-direction: column; color: #ef4444;">
            <div style="font-size: 11px;">Failed to load ongoing session.</div>
          </div>
        `;
            }
        }

        async function loadJourneyTelemetry(journeyId) {
            if (!backendBaseUrl || !journeyId) return;
            try {
                log(`Loading telemetry for journey: ${journeyId}`);
                const url = `${backendBaseUrl}/api/journeys/${journeyId}`;
                const res = await fetch(url);
                const json = await res.json();
                const journey = json?.data || json;

                // Extract telemetry JSON
                const telemetryJson = journey?.telemetry_json || journey?.telemetry || null;

                if (telemetryJson) {
                    state.telemetryData = typeof telemetryJson === 'string' ? JSON.parse(telemetryJson) : telemetryJson;
                    state.journeyId = journeyId;
                    setK("s_journey", journeyId);

                    // Display telemetry in viewer
                    const viewer = document.getElementById("telemetryViewer");
                    viewer.innerHTML = `<pre>${JSON.stringify(state.telemetryData, null, 2)}</pre>`;
                    viewer.style.display = "block";
                    viewer.style.background = "#f9fafb";
                    viewer.style.padding = "10px";

                    log(`Telemetry loaded successfully. Frames: ${state.telemetryData?.frames?.length || 0}`);

                    // Send event that telemetry is loaded
                    sendEvent('telemetry_loaded', { journeyId: journeyId, frameCount: state.telemetryData?.frames?.length || 0 });
                } else {
                    log("No telemetry data found for journey");
                    document.getElementById("telemetryViewer").innerHTML = `
            <div style="flex: 1; display: flex; align-items: center; justify-content: center; flex-direction: column; color: #f59e0b;">
              <div style="font-size: 11px;">No telemetry data available</div>
            </div>
          `;
                }
            } catch (e) {
                log("loadJourneyTelemetry error: " + (e?.message || e));
                document.getElementById("telemetryViewer").innerHTML = `
          <div style="flex: 1; display: flex; align-items: center; justify-content: center; flex-direction: column; color: #ef4444;">
            <div style="font-size: 11px;">Failed to load telemetry</div>
          </div>
        `;
            }
        }

        function updateMotionFromTelemetry(positionMs) {
            if (!state.telemetryData || !state.telemetryData.frames) return;

            // Find the appropriate telemetry frame based on position
            const frames = state.telemetryData.frames;
            const currentFrame = frames.find((frame, index) => {
                const nextFrame = frames[index + 1];
                if (!nextFrame) return true; // Last frame
                return positionMs >= frame.timestamp && positionMs < nextFrame.timestamp;
            });

            if (currentFrame) {
                state.currentFrame = currentFrame;
                setK("current_frame", `${frames.indexOf(currentFrame) + 1} / ${frames.length}`);

                // Update motion indicators
                setK("motion_pitch", `${(currentFrame.pitch || 0).toFixed(1)}¬∞`);
                setK("motion_roll", `${(currentFrame.roll || 0).toFixed(1)}¬∞`);
                setK("motion_yaw", `${(currentFrame.yaw || 0).toFixed(1)}¬∞`);
                setK("motion_heave", `${(currentFrame.heave || 0).toFixed(1)}mm`);
                setK("motion_surge", `${(currentFrame.surge || 0).toFixed(1)}mm`);
                setK("motion_sway", `${(currentFrame.sway || 0).toFixed(1)}mm`);
            }
        }

        function handleCmd(data) {
            const cmd = (data.command || data.type || "").toLowerCase();
            const cmdJourneyId = data.journeyId != null ? String(data.journeyId) : null;

            if (cmd === "start" || cmd === "play") {
                if (cmdJourneyId && cmdJourneyId !== state.journeyId) {
                    loadJourneyTelemetry(cmdJourneyId);
                }
                if (typeof data.positionMs === "number") state.positionMs = data.positionMs;
                state.playing = true;
                setK("s_state", "‚ñ∂ Playing");
                updateMotionFromTelemetry(state.positionMs);
            } else if (cmd === "pause") {
                if (typeof data.positionMs === "number") {
                    state.positionMs = data.positionMs;
                }
                state.playing = false;
                setK("s_state", "‚è∏ Paused");
                updateMotionFromTelemetry(state.positionMs);
            } else if (cmd === "seek") {
                if (typeof data.positionMs === "number") {
                    state.positionMs = data.positionMs;
                }
                setK("s_state", "‚è© Seeking");
                updateMotionFromTelemetry(state.positionMs);
            } else if (cmd === "stop" || cmd === "reset") {
                state.playing = false;
                state.positionMs = 0;
                setK("s_state", "‚èπ Stopped");
                // Reset motion indicators
                setK("motion_pitch", "0.0¬∞");
                setK("motion_roll", "0.0¬∞");
                setK("motion_yaw", "0.0¬∞");
                setK("motion_heave", "0.0mm");
                setK("motion_surge", "0.0mm");
                setK("motion_sway", "0.0mm");
                setK("current_frame", "-");
            } else if (cmd === "calibrate") {
                setK("s_state", "üîß Calibrating");
            } else if (cmd === "join_session") {
                const sid = String(data.sessionId || data.session_id || "").trim();
                if (sid) {
                    document.getElementById("sessionInput").value = sid;
                    joinSession();
                }
            } else if (cmd === "leave_session") {
                leaveSession();
            } else if (cmd === "select_journey") {
                const jid = (data.journeyId != null ? String(data.journeyId) : "").trim();
                log(`Selecting journey ${jid} for telemetry`);
                loadJourneyTelemetry(jid);
            }

            // Update position display
            const pos = Math.max(0, Math.floor(state.positionMs));
            const sec = Math.floor(pos / 1000);
            const min = Math.floor(sec / 60);
            const s = sec % 60;
            setK("s_pos", `${min}:${s.toString().padStart(2, "0")}`);

            // Also emit a status update
            const statusPayload = {
                deviceId: state.id,
                type: state.type,
                status: state.playing ? "active" : "idle",
                positionMs: Math.floor(state.positionMs),
                sessionId: state.sessionId || "",
                journeyId: state.journeyId || "",
                timestamp: new Date().toISOString(),
            };
            pub(T_status(state.id), JSON.stringify(statusPayload), false);
            try {
                if (bridge && connected) bridge.emit("device:status", statusPayload);
            } catch { }
        }

        function startTicker() {
            if (ticker) return;
            state.lastTick = Date.now();
            ticker = setInterval(() => {
                const now = Date.now();
                const dt = now - state.lastTick;
                state.lastTick = now;

                if (state.playing) {
                    state.positionMs += dt;
                    updateMotionFromTelemetry(state.positionMs);
                }

                const pos = Math.max(0, Math.floor(state.positionMs));
                const sec = Math.floor(pos / 1000);
                const min = Math.floor(sec / 60);
                const s = sec % 60;
                setK("s_pos", `${min}:${s.toString().padStart(2, "0")}`);
            }, 100); // Update more frequently for smooth motion updates
        }

        // Send heartbeat every 15 seconds (Socket.IO + MQTT)
        setInterval(() => {
            if (!connected) return;
            const hb = {
                deviceId: state.id,
                type: state.type,
                timestamp: new Date().toISOString(),
                status: state.playing ? "active" : "idle",
            };
            try {
                if (bridge) bridge.emit("device:heartbeat", hb);
            } catch { }
            pub(T_heartbeat(state.id), JSON.stringify(hb), false);
        }, 15000);

        function stopTicker() {
            if (ticker) {
                clearInterval(ticker);
                ticker = null;
            }
        }
    </script>
</body>

</html>